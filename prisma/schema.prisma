generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  passwordHash  String   @map("password_hash")
  role          UserRole @default(STUDENT)
  displayName   String?  @map("display_name")
  department    String?
  avatarUrl     String?  @map("avatar_url")
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations - Pillar II: Voice
  grievances        Grievance[]
  grievanceUpdates  GrievanceUpdate[]
  
  // Relations - Pillar III: Fate
  taughtCourses     Course[]      @relation("ProfessorCourses")
  enrollments       Enrollment[]
  resources         Resource[]
  
  // Relations - Pillar IV: Opportunity
  opportunities     Opportunity[]
  applications      Application[]
  tasks             Task[]

  @@map("users")
}

enum UserRole {
  STUDENT
  FACULTY
  AUTHORITY
  ADMIN
}

model Grievance {
  id            String    @id @default(uuid())
  submitterId   String?   @map("submitter_id")
  category      GrievanceCategory
  priority      Priority
  location      String
  title         String
  description   String    @db.Text
  status        GrievanceStatus @default(SUBMITTED)
  isAnonymous   Boolean   @default(false) @map("is_anonymous")
  photos        String[]  // Array of file paths
  assignedTo    String?   @map("assigned_to")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  submitter     User?     @relation(fields: [submitterId], references: [id])
  updates       GrievanceUpdate[]

  @@map("grievances")
}

enum GrievanceCategory {
  INFRASTRUCTURE
  ACADEMICS
  HOSTEL
  FOOD
  OTHER
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum GrievanceStatus {
  SUBMITTED
  UNDER_REVIEW
  IN_PROGRESS
  RESOLVED
}

model GrievanceUpdate {
  id            String    @id @default(uuid())
  grievanceId   String    @map("grievance_id")
  updatedBy     String    @map("updated_by")
  status        GrievanceStatus
  remark        String    @db.Text
  createdAt     DateTime  @default(now()) @map("created_at")

  grievance     Grievance @relation(fields: [grievanceId], references: [id], onDelete: Cascade)
  updater       User      @relation(fields: [updatedBy], references: [id])

  @@map("grievance_updates")
}

model Course {
  id            String   @id @default(uuid())
  code          String   @unique
  name          String
  credits       Int
  semester      String
  professorId   String?  @map("professor_id")
  department    String
  description   String?  @db.Text
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  professor     User?    @relation("ProfessorCourses", fields: [professorId], references: [id])
  enrollments   Enrollment[]
  resources     Resource[]
  events        CalendarEvent[]

  @@map("courses")
}

model Enrollment {
  id              String   @id @default(uuid())
  studentId       String   @map("student_id")
  courseId        String   @map("course_id")
  semester        String
  attendanceCount Int      @default(0) @map("attendance_count")
  totalClasses    Int      @default(0) @map("total_classes")
  enrolledAt      DateTime @default(now()) @map("enrolled_at")

  student         User     @relation(fields: [studentId], references: [id])
  course          Course   @relation(fields: [courseId], references: [id])

  @@unique([studentId, courseId, semester])
  @@map("enrollments")
}

model Resource {
  id          String       @id @default(uuid())
  courseId    String       @map("course_id")
  uploaderId  String       @map("uploader_id")
  type        ResourceType
  title       String
  year        Int
  examType    String?      @map("exam_type")
  filePath    String       @map("file_path")
  tags        String[]
  downloads   Int          @default(0)
  createdAt   DateTime     @default(now()) @map("created_at")

  course      Course       @relation(fields: [courseId], references: [id])
  uploader    User         @relation(fields: [uploaderId], references: [id])

  @@map("resources")
}

enum ResourceType {
  PAPER
  NOTES
  OTHER
}

model CalendarEvent {
  id          String   @id @default(uuid())
  courseId    String?  @map("course_id")
  title       String
  description String?  @db.Text
  eventType   String   @map("event_type")
  startDate   DateTime @map("start_date")
  endDate     DateTime @map("end_date")
  createdBy   String   @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at")

  course      Course?  @relation(fields: [courseId], references: [id])

  @@map("calendar_events")
}

model Opportunity {
  id          String   @id @default(uuid())
  facultyId   String   @map("faculty_id")
  title       String
  description String   @db.Text
  skills      String[]
  duration    String
  stipend     String?
  deadline    DateTime
  isOpen      Boolean  @default(true) @map("is_open")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  faculty     User     @relation(fields: [facultyId], references: [id])
  applications Application[]

  @@map("opportunities")
}

model Application {
  id          String            @id @default(uuid())
  opportunityId String          @map("opportunity_id")
  studentId   String            @map("student_id")
  status      ApplicationStatus @default(SUBMITTED)
  resumePath  String?           @map("resume_path")
  coverLetter String?           @db.Text @map("cover_letter")
  appliedAt   DateTime          @default(now()) @map("applied_at")
  updatedAt   DateTime          @updatedAt @map("updated_at")

  opportunity Opportunity       @relation(fields: [opportunityId], references: [id])
  student     User              @relation(fields: [studentId], references: [id])

  @@unique([opportunityId, studentId])
  @@map("applications")
}

enum ApplicationStatus {
  SUBMITTED
  UNDER_REVIEW
  SHORTLISTED
  ACCEPTED
  REJECTED
}

model Task {
  id          String     @id @default(uuid())
  studentId   String     @map("student_id")
  title       String
  description String?    @db.Text
  category    String
  deadline    DateTime?
  status      TaskStatus @default(PENDING)
  progress    Int        @default(0)
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")

  student     User       @relation(fields: [studentId], references: [id])

  @@map("tasks")
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
}